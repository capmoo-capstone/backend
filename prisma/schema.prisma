// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum UserRole {
  SUPER_ADMIN
  ADMIN
  HEAD_OF_DEPARTMENT
  HEAD_OF_UNIT
  REPRESENTATIVE
  DOCUMENT_STAFF
  FINANCE_STAFF
  GENERAL_STAFF
  GUEST
}

enum ProjectStatus {
  UNASSIGNED
  WAITING_ACCEPT
  IN_PROGRESS
  WAITING_CANCEL
  CANCELLED
  CLOSED
  REQUEST_EDIT
}

enum UnitResponsibleType {
  LT100K
  LT500K
  MT500K
  SELECTION
  EBIDDING
  CONTRACT
}

enum LogActionType {
  INFORMATION_UPDATE
  STATUS_UPDATE
  ASSIGNEE_UPDATE
  STEP_UPDATE
}

enum ProcurementType {
  LT100K
  LT500K
  MT500K
  SELECTION
  EBIDDING
}

enum SubmissionStatus {
  WAITING_APPROVAL
  WAITING_PROPOSAL
  WAITING_SIGNATURE
  COMPLETED
  REJECTED
}

enum ProjectPhaseStatus {
  NOT_STARTED
  IN_PROGRESS
  WAITING_APPROVAL
  WAITING_PROPOSAL
  WAITING_SIGNATURE
  COMPLETED
  REJECTED
}

enum SubmissionType {
  STAFF
  VENDOR
}

enum UrgentType {
  NORMAL
  URGENT
  VERY_URGENT
}

// --- MODELS ---

model Department {
  id           String        @id @default(uuid())
  name         String
  code         String
  units        Unit[]
  allowed_role AllowedRole[]
  users        User[]

  @@map("departments")
}

model Unit {
  id      String                @id @default(uuid())
  dept_id String
  name    String
  type    UnitResponsibleType[]

  dept     Department @relation(fields: [dept_id], references: [id])
  users    User[]
  projects Project[]

  @@map("units")
}

model User {
  id                String    @id @default(uuid())
  dept_id           String?
  unit_id           String?
  username          String    @unique
  email             String?   @unique
  full_name         String
  role              UserRole?
  is_delegating     Boolean   @default(false)
  delegated_user_id String?
  created_at        DateTime  @default(now())

  dept Department? @relation(fields: [dept_id], references: [id])
  unit Unit?       @relation(fields: [unit_id], references: [id])

  delegate_to    User?  @relation("UserDelegation", fields: [delegated_user_id], references: [id])
  delegated_from User[] @relation("UserDelegation")

  procurement_projects Project[] @relation("ProcurementProjects")
  contract_projects    Project[] @relation("ContractProjects")
  created_projects     Project[] @relation("ProjectCreator")

  submitted_submissions  ProjectSubmission[]   @relation("SubmitBy")
  approved_submissions   ProjectSubmission[]   @relation("ApprovedBy")
  proposed_submissions   ProjectSubmission[]   @relation("ProposedBy")
  completed_submissions  ProjectSubmission[]   @relation("CompletedBy")
  cancellation_requests  ProjectCancellation[] @relation("CancelRequester")
  cancellation_approvals ProjectCancellation[] @relation("CancelApprover")

  @@map("users")
}

model AllowedRole {
  id      String   @id @default(uuid())
  dept_id String
  role    UserRole

  dept Department @relation(fields: [dept_id], references: [id])

  @@unique([dept_id, role])
  @@map("allowed_roles")
}

model Project {
  id                     String              @id @default(uuid())
  receive_no             String
  title                  String
  description            String?
  budget                 Decimal             @db.Decimal(18, 2)
  status                 ProjectStatus
  procurement_type       ProcurementType
  current_workflow_type  UnitResponsibleType
  requesting_unit_id     String?
  is_urgent              UrgentType          @default(NORMAL)
  expected_approval_date DateTime?
  pr_no                  String?
  po_no                  String?
  less_no                String?
  contract_no            String?
  migo_no                String?
  vendor_name            String?
  vendor_tax_id          String?
  vendor_email           String?
  created_by             String
  created_at             DateTime            @default(now())
  updated_at             DateTime?           @updatedAt

  creator         User  @relation("ProjectCreator", fields: [created_by], references: [id])
  requesting_unit Unit? @relation(fields: [requesting_unit_id], references: [id])

  assignee_procurement User[]                @relation("ProcurementProjects")
  assignee_contract    User[]                @relation("ContractProjects")
  project_cancellation ProjectCancellation[]
  project_histories    ProjectHistory[]
  submissions          ProjectSubmission[]

  @@map("projects")
}

model ProjectCancellation {
  id           String    @id @default(uuid())
  project_id   String
  reason       String
  is_active    Boolean   @default(true)
  is_cancelled Boolean   @default(false)
  requested_by String
  requested_at DateTime  @default(now())
  approved_by  String?
  approved_at  DateTime?
  cancelled_at DateTime?

  project   Project @relation(fields: [project_id], references: [id])
  requester User    @relation("CancelRequester", fields: [requested_by], references: [id])
  approver  User?   @relation("CancelApprover", fields: [approved_by], references: [id])

  @@map("project_cancellations")
}

model ProjectHistory {
  id         String        @id @default(uuid())
  project_id String
  action     LogActionType
  old_value  Json
  new_value  Json
  comment    String?
  changed_by String
  changed_at DateTime      @default(now())

  project Project @relation(fields: [project_id], references: [id])

  @@map("project_histories")
}

model ProjectSubmission {
  id               String              @id @default(uuid())
  project_id       String
  workflow_type    UnitResponsibleType
  step_order       Int
  submission_type  SubmissionType      @default(STAFF)
  submission_round Int
  po_no            String?
  status           SubmissionStatus
  submitted_by     String?
  submitted_at     DateTime            @default(now())
  approved_by      String?
  approved_at      DateTime?
  proposing_by     String?
  proposing_at     DateTime?
  completed_by     String?
  completed_at     DateTime?
  comment          String?
  meta_data        Json[]

  project   Project           @relation(fields: [project_id], references: [id])
  submitter User?             @relation("SubmitBy", fields: [submitted_by], references: [id])
  approver  User?             @relation("ApprovedBy", fields: [approved_by], references: [id])
  proposer  User?             @relation("ProposedBy", fields: [proposing_by], references: [id])
  completer User?             @relation("CompletedBy", fields: [completed_by], references: [id])
  documents ProjectDocument[]

  @@map("project_submissions")
}

model ProjectDocument {
  id            String  @id @default(uuid())
  submission_id String
  field_key     String?
  file_name     String
  file_path     String

  submission ProjectSubmission @relation(fields: [submission_id], references: [id], onDelete: Cascade)

  @@map("project_documents")
}
