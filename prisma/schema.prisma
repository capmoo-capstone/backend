// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum UserRole {
  SUPER_ADMIN
  ADMIN
  HEAD_OF_DEPARTMENT
  HEAD_OF_UNIT
  REPRESENTATIVE
  DOCUMENT_STAFF
  FINANCE_STAFF
  GENERAL_STAFF
  GUEST
}

enum ProjectStatus {
  UNASSIGNED
  WAITING_ACCEPT
  IN_PROGRESS
  WAITING_CANCEL
  CANCELLED
  CLOSED
  REQUEST_EDIT
}

enum UnitResponsibleType {
  LT100K
  LT500K
  MT500K
  SELECTION
  EBIDDING
  CONTRACT
}

enum LogActionType {
  INFORMATION_UPDATE
  STATUS_UPDATE
  ASSIGNEE_UPDATE
  STEP_UPDATE
}

enum ProcurementType {
  LT100K
  LT500K
  MT500K
  SELECTION
  EBIDDING
}

enum SubmissionStatus {
  SUBMITTED
  PENDING_PROPOSAL
  PROPOSING
  COMPLETED
  REJECTED
}

enum SubmissionType {
  STAFF
  VENDOR
}

// --- MODELS ---

model Department {
  id           String        @id @default(uuid())
  name         String
  code         String
  units        Unit[]
  allowed_role AllowedRole[]
  users        User[]

  @@map("departments")
}

model Unit {
  id      String                @id @default(uuid())
  dept_id String
  name    String
  type    UnitResponsibleType[]

  dept     Department @relation(fields: [dept_id], references: [id])
  users    User[]
  projects Project[]

  @@map("units")
}

model User {
  id                String    @id @default(uuid())
  dept_id           String?
  unit_id           String?
  username          String    @unique
  email             String?   @unique
  full_name         String
  role              UserRole?
  is_delegating     Boolean   @default(false)
  delegated_user_id String?
  created_at        DateTime  @default(now())

  dept Department? @relation(fields: [dept_id], references: [id])
  unit Unit?       @relation(fields: [unit_id], references: [id])

  // Self-relation for delegation
  delegate_to    User?  @relation("UserDelegation", fields: [delegated_user_id], references: [id])
  delegated_from User[] @relation("UserDelegation")

  // Relations to Projects
  created_projects      Project[]           @relation("ProjectCreator")
  procurement_projects  Project[]           @relation("ProcurementAssignee")
  contract_projects     Project[]           @relation("ContractAssignee")
  submitted_submissions ProjectSubmission[] @relation("SubmitBy")
  approved_submissions  ProjectSubmission[] @relation("ApprovedBy")

  @@map("users")
}

model AllowedRole {
  id      String   @id @default(uuid())
  dept_id String
  role    UserRole

  dept Department @relation(fields: [dept_id], references: [id])

  @@unique([dept_id, role])
  @@map("allowed_roles")
}

model Project {
  id                      String          @id @default(uuid())
  receive_no              String
  title                   String
  description             String?
  budget                  Decimal         @db.Decimal(18, 2)
  pr_no                   String?
  po_no                   String?
  less_no                 String?
  status                  ProjectStatus
  requesting_unit_id      String?
  procurement_type        ProcurementType
  current_template_id     String
  current_step_id         String?
  assignee_procurement_id String?
  assignee_contract_id    String?
  contract_no             String?
  migo_no                 String?
  vendor_name             String?
  vendor_tax_id           String?
  vendor_email            String?
  is_urgent               Boolean         @default(false)
  expected_approval_date  DateTime?
  created_by              String
  created_at              DateTime        @default(now())
  updated_at              DateTime?       @updatedAt

  // Relations
  current_template     WorkflowTemplate @relation(fields: [current_template_id], references: [id])
  current_step         WorkflowStep?    @relation(fields: [current_step_id], references: [id])
  creator              User             @relation("ProjectCreator", fields: [created_by], references: [id])
  assignee_procurement User?            @relation("ProcurementAssignee", fields: [assignee_procurement_id], references: [id])
  assignee_contract    User?            @relation("ContractAssignee", fields: [assignee_contract_id], references: [id])
  requesting_unit      Unit?            @relation(fields: [requesting_unit_id], references: [id])

  project_cancellation ProjectCancellation[]
  project_histories    ProjectHistory[]
  submissions          ProjectSubmission[]

  @@map("projects")
}

model ProjectCancellation {
  id           String   @id @default(uuid())
  project_id   String
  reason       String
  is_cancelled Boolean  @default(false)
  cancelled_by String
  cancelled_at DateTime @default(now())

  project Project @relation(fields: [project_id], references: [id])

  @@map("project_cancellations")
}

model ProjectHistory {
  id         String        @id @default(uuid())
  project_id String
  action     LogActionType
  old_value  Json
  new_value  Json
  comment    String?
  changed_by String
  changed_at DateTime      @default(now())

  project Project @relation(fields: [project_id], references: [id])

  @@map("project_histories")
}

model ProjectSubmission {
  id               String           @id @default(uuid())
  project_id       String
  step_id          String?
  submission_type  SubmissionType   @default(STAFF)
  submission_round Int?
  po_no            String?
  status           SubmissionStatus
  submitted_by     String?
  submitted_at     DateTime         @default(now())
  approved_by      String?
  approved_at      DateTime?
  proposing_by     String?
  proposing_at     DateTime?
  completed_by     String?
  completed_at     DateTime?
  comment          String?
  meta_data        Json[]

  project   Project           @relation(fields: [project_id], references: [id])
  step      WorkflowStep?     @relation(fields: [step_id], references: [id])
  submitter User?             @relation("SubmitBy", fields: [submitted_by], references: [id])
  approver  User?             @relation("ApprovedBy", fields: [approved_by], references: [id])
  documents ProjectDocument[]

  @@map("project_submissions")
}

model ProjectDocument {
  id            String  @id @default(uuid())
  submission_id String
  field_key     String?
  file_name     String
  file_path     String

  submission ProjectSubmission @relation(fields: [submission_id], references: [id], onDelete: Cascade)

  @@map("project_documents")
}

model WorkflowTemplate {
  id          String              @id @default(uuid())
  name        String
  type        UnitResponsibleType
  description String?
  steps       WorkflowStep[]
  projects    Project[]

  @@map("workflow_templates")
}

model WorkflowStep {
  id                 String  @id @default(uuid())
  template_id        String
  order              Int
  name               String
  description        String
  required_step      Int[]
  required_documents Json[]
  requires_signature Boolean @default(false)

  template    WorkflowTemplate    @relation(fields: [template_id], references: [id])
  projects    Project[]
  submissions ProjectSubmission[]

  @@map("workflow_steps")
}
